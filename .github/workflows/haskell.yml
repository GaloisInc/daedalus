name: Haskell CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-haskell@v1
      id: setup-haskell
      with:
        ghc-version: '8.8.3'
        cabal-version: '3.2'

    - name: Cache
      uses: actions/cache@v2
      env:
        cache-name: cache-cabal
      with:
        path: |
          ${{ steps.setup-haskell.outputs.cabal-store }}
          dist-newstyle
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/*.cabal') }}-${{ hashFiles('**/cabal.project') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-

    - name: Install dependencies
      run: |
        cabal update
        cabal build --only-dependencies --enable-tests
    - name: Build Daedalus
      run: cabal build --enable-tests exe:daedalus
    - name: Build ICC Parser
      run: cabal build exe:icc-parser
    - name: Build PDF driver
      run: cabal build exe:pdf-hs-driver
    - name: Build PDF dom
      run: cabal build exe:pdf-dom
    - name: Build Talos
      run: cabal build exe:talos 
    - name: Run Daedalus tests
      run: cabal test daedalus-tests
    - name: Run Talos tests 
      run: | 
        cd talos 
        cabal test talos-tests
